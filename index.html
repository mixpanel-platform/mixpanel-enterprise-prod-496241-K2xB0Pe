<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://d621cde4587c562960fbe230744f42dc2304ca4f.googledrive.com/host/0BxwayM8qQaCVX0w4RExCOVdhbzQ">
    <link rel="stylesheet" type="text/css" href="https://a7fd22d7f1e3c3ec503950ff3eb0ca354866665d.googledrive.com/host/0BxwayM8qQaCVMk14UTA0V2JuSVU">
    <link rel="stylesheet" type="text/css" href="https://5a4961e5c9f1459a1c463234568af125d8e1b386.googledrive.com/host/0BxwayM8qQaCVRmRCSDlXUUtMMnc/">
    <link rel="stylesheet" type="text/css" href="https://201420392a7158f07d53a8f3e71606645ab03bd2.googledrive.com/host/0BxwayM8qQaCVQldvY2U5Um9FN3M">
    <script src="//cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">


  </head>
  <body class="mixpanel-platform-body">
  <div class="content-wrapper">
            <div class="content-heading text-center">
               <!-- START Language list-->
               <div class="pull-right" style="bottom: 10px;">
                  <img src="https://d018d7277c9a2a72c253b637c4abe4d24d29449c.googledrive.com/host/0BxwayM8qQaCVOGZvekkxYTNSZVU" height="40px" width="120px">
                  
               </div>
               <div class="pull-left">
                  <!--<img src="https://904d537b177e27fb469b44e90a0d758dec0d3d71.googledrive.com/host/0BxwayM8qQaCVUTRRRC15OXpvVkk" height="30px" width="124px">-->
               </div>
               <!-- END Language list    -->
               Quarterly Dashboard
               <small data-localize="dashboard.WELCOME"></small>
            </div>
            <!-- START widgets box-->
            <div class="row">
               <div class="col-lg-3 col-sm-3">
                  <!-- START widget-->
                  <div class="panel widget bg-primary">
                     <div class="row row-table">
                        <div class="col-xs-4 text-center bg-primary-dark pv-lg">
                           <em class="icon-speedometer fa-3x"></em>
                        </div>
                        <div class="col-xs-8 pv-lg">
                           <div class="h2 mt0 current-users text-center">0</div>
                           <div class="text-uppercase text-center">Logins</div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="col-lg-3 col-sm-3">
                  <!-- START widget-->
                  <div class="panel widget bg-purple">
                     <div class="row row-table">
                        <div class="col-xs-4 text-center bg-purple-dark pv-lg">
                           <em class="icon-users fa-3x"></em>
                        </div>
                        <div class="col-xs-11 pv-lg">
                           <div class="h2 mt0 monthly-actives pull-left">0
                              <!--<small>GB</small>-->
                           </div>
                           <div class="text-uppercase text-center">QAU'S</div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="col-lg-3 col-md-6 col-sm-3">
                  <!-- START widget-->
                  <div class="panel widget bg-green">
                     <div class="row row-table">
                        <div class="col-xs-4 text-center bg-green-dark pv-lg">
                           <em class="icon-energy fa-3x"></em>
                        </div>
                        <div class="col-xs-11 pv-lg">
                           <div class="h2 mt0 daily-actives text-center">0</div>
                           <div class="text-uppercase text-center">MAU's</div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="col-lg-3 col-md-6 col-sm-3">
                  <!-- START date widget-->
                  <div class="panel widget">
                     <div class="row row-table">
                        <div class="col-xs-4 text-center bg-green pv-lg">
                           <!-- See formats: https://docs.angularjs.org/api/ng/filter/date-->
                           <div data-now="" data-format="MMMM" class="text-sm date-month text-center"></div>
                           <br>
                           <div data-now="" data-format="D" class="h2 mt0 date-day text-center"></div>
                        </div>
                        <div class="col-xs-8 pv-lg">
                           <div data-now="" data-format="dddd" class="text-uppercase date-actual-day text-center"></div>
                           <br>
                           <div data-now="" data-format="h:mm" class="h2 mt0 date-time"></div>
                           <div data-now="" data-format="a" class="text-muted text-sm date-pm"></div>
                        </div>
                     </div>
                  </div>
                  <!-- END date widget    -->
               </div>
            </div>
         
        </div>



    <script>
        /* Get top events */

        events = [];
        MP.api.topEvents().done(function(results) {
          _.each(_.values(results.values()), function(value){
              events.push(value);
          })
          refresh();
        });

        function toTitleCase(str)
        {
          return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        }

        function addCommas(intNum) {
          return (intNum + '').replace(/(\d)(?=(\d{3})+$)/g, '$1,');
        }

        var refresh = function(){
          /* 
              Get total event counts 
              event:App Open
              type:general
              limit:255
              on:properties["First App Open"]
              to_date:2015-11-11
              from_date:2015-10-13
              unit:day
          */
            // var loginQuery = MP.api.query('/api/2.0/arb_funnels/', {event:'App Open', unit: '',type:'unique'})
            var funnelParams = {
                from: moment().subtract(3, 'months'),
                to: moment(),
                limit: 100,                             // maximum number of results to return
                length: 14,                             // number of days each user has to complete the funnel
                
            };
            var loginQuery = MP.api.funnel('Log in succeeded', 'Logged out', funnelParams);
            loginQuery.done(function(json) {
              console.log(json);
              var values = json.data.values;
              var data = _.values(json.data.values)[0];

              /* iterate through the keys in the values dictionary in reverse order.  grab the first and second that have data*/
              var sortedKeys = _.keys(data)

              /* sort and reverse */
              sortedKeys.sort()
              sortedKeys.reverse()
              var current = 0
              var lastMinute = 0
              var count = 0

              while (count <= sortedKeys.length) {
                  if (data[sortedKeys[count]] > 0) {
                      console.log(sortedKeys[count])
                      console.log(sortedKeys[count + 1])
                      current = data[sortedKeys[count]]
                      try {
                          lastMinute = data[sortedKeys[count + 1]]
                      } catch (err){
                          lastMinute = data[sortedKeys[0]]
                      }
                      break;
                  }
                  count ++
              }

              var totalCurrentUsers = current + lastMinute;
              $('.current-users').text(addCommas(totalCurrentUsers));
              /* Show this now */

            })
            /* Query for Monthly Active Users */
            var monthlyQuery = MP.api.query('/api/2.0/events/', {event:events, unit: 'month', union: 1, type:'unique'}, {dataType: 'json'}) 
            monthlyQuery.done(function(json){
                console.log(json)
                var data = _.values(json.data.values)
                var monthlyActives = _.values(data[0])[0]

                $('.monthly-actives').text(addCommas(monthlyActives));
            });

            var dailyQuery = MP.api.query('/api/2.0/events/', {event:["Licensed Content Purchase","Purchase"], unit: 'week', interval:1, union:1}, {dataType: 'json'});
            dailyQuery.done(function(json){

                var data = _.values(json.data.values)[0];
                var dataKeys = _.keys(data).sort().reverse()
                var dailyActives = data[dataKeys[0]];
                console.log(dailyActives);
                $('.daily-actives').text(addCommas(dailyActives));
            })
            /* Date Refresh */
            var date = new Date();
            var day = date.getDate()
            var hours = date.getHours();
            var convertedHours = hours <= 12 ? hours : hours - 12;
            var ampm = hours >= 12 ? 'pm' : 'am';
            var time = convertedHours.toString() + ':' + pad(date.getMinutes()).toString();
            var month = getCurrentMonth();
            var actualDay = getCurrentDay();

            $('.date-month').text(month);
            $('.date-actual-day').text(actualDay);
            $('.date-day').text(day.toString());
            $('.date-time').text(time);
            $('.date-pm').text(ampm);

          
        }

        setInterval(refresh, 30000);

        function pad(d) {
            return (d < 10) ? '0' + d.toString() : d.toString();
        }


        function getCurrentMonth(){

            var d = new Date();

            var month = new Array();
            month[0] = "JAN"; 
            month[1] = "FEB";
            month[2] = "MAR";
            month[3] = "APR";
            month[4] = "MAY";
            month[5] = "JUNE";
            month[6] = "JULY";
            month[7] = "AUG";
            month[8] = "SEPT";
            month[9] = "OCT";
            month[10] = "NOV";
            month[11] = "DEC";
            var n = month[d.getMonth()];

            return n;
        }

        function getCurrentDay(){
            var d = new Date();
            var weekday = new Array(7);
            weekday[0]=  "Sunday";
            weekday[1] = "Monday";
            weekday[2] = "Tuesday";
            weekday[3] = "Wednesday";
            weekday[4] = "Thursday";
            weekday[5] = "Friday";
            weekday[6] = "Saturday";

            var n = weekday[d.getDay()];
            return n;
        }

    </script>
  </body>
</html>
